import requests
import time
import re
import os
import sys

# ==================== âš™ï¸ é…ç½®åŒºåŸŸ ====================

# 1. ğŸ”´ è¯·åŠ¡å¿…å¡«å…¥ä½ çš„ TMDB API Key
API_KEY = "fca50a131e18c871c838d4a6ec065be3"

# 2. ä½ çš„æ¥æº SQL æ–‡ä»¶å (å°±æ˜¯åˆšæ‰çˆ¬è™«ç”Ÿæˆçš„é‚£ä¸ª)
INPUT_SQL_FILE = "filmdb_staging_update.sql"

# 3. ç”Ÿæˆçš„è¡¥ä¸æ–‡ä»¶å (ç»“æœ)
OUTPUT_SQL_FILE = "fix_runtimes_precise.sql"

# ==================== ğŸ› ï¸ æ ¸å¿ƒå·¥å…·å‡½æ•° ====================

def get_json(url, params=None):
    """è¯·æ±‚ APIï¼Œæ”¯æŒè‡ªåŠ¨é‡è¯•å’Œå‚æ•°ç¼–ç """
    retries = 3
    for i in range(retries):
        try:
            # timeout=10 é˜²æ­¢ç½‘ç»œå¡æ­»
            response = requests.get(url, params=params, timeout=10)
            
            # å¦‚æœè§¦å‘é™æµ (429 Too Many Requests)ï¼Œä¼‘æ¯ä¸€ä¸‹
            if response.status_code == 429:
                print("âš ï¸ è§¦å‘é™æµï¼Œç­‰å¾… 5 ç§’...")
                time.sleep(5)
                continue
                
            if response.status_code == 200:
                return response.json()
        except Exception:
            time.sleep(1)
    return None

def extract_movies_from_file(filename):
    """
    ä» SQL æ–‡ä»¶ä¸­ç²¾å‡†æå–ï¼šID, Title, Year
    åªæå– runtime=90 çš„è®°å½•ï¼ˆå³æˆ‘ä»¬ä¸Šæ¬¡çˆ¬å–çš„å ä½ç¬¦è®°å½•ï¼‰
    """
    if not os.path.exists(filename):
        print(f"âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ {filename}")
        print("   è¯·ç¡®ä¿è¿™ä¸ª Python è„šæœ¬å’Œ sql æ–‡ä»¶åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œï¼")
        return []

    movies = []
    # æ­£åˆ™è¡¨è¾¾å¼ï¼šç²¾å‡†åŒ¹é… new_movies_staging è¡¨çš„ INSERT è¯­å¥
    # æ ¼å¼ç¤ºä¾‹: INSERT INTO new_movies_staging VALUES(9205, 'Dune', 'us', 2024, 90);
    # é€»è¾‘ï¼šåŒ¹é… VALUES(æ•°å­—, 'ä»»æ„å­—ç¬¦', 'ä»»æ„å­—ç¬¦', æ•°å­—, 90)
    pattern = re.compile(r"INSERT INTO new_movies_staging VALUES\((\d+),\s*'([^']*(?:''[^']*)*)',\s*'[^']+',\s*(\d+),\s*90\);", re.IGNORECASE)

    print(f"ğŸ“– æ­£åœ¨è§£æ {filename} ...")
    try:
        with open(filename, 'r', encoding='utf-8') as f:
            for line in f:
                match = pattern.search(line)
                if match:
                    local_id = match.group(1)
                    # è¿˜åŸæ ‡é¢˜ï¼šæŠŠ SQL è½¬ä¹‰çš„ '' å˜å› ' (ä¾‹å¦‚ O''Neil -> O'Neil)
                    raw_title = match.group(2).replace("''", "'")
                    year = match.group(3)
                    
                    movies.append({
                        "id": local_id,
                        "title": raw_title,
                        "year": year
                    })
    except Exception as e:
        print(f"âŒ è¯»å–æ–‡ä»¶å‡ºé”™: {e}")
        return []
        
    return movies

# ==================== ğŸš€ ä¸»ç¨‹åº ====================

def main():
    # 0. æ£€æŸ¥ Key
    if "YOUR_TMDB" in API_KEY:
        print("âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨ä»£ç ç¬¬ 10 è¡Œå¡«å…¥ä½ çš„ API Keyï¼")
        return

    # 1. è§£æ SQL æ–‡ä»¶ï¼Œæ‹¿åˆ°ä»»åŠ¡æ¸…å•
    movie_list = extract_movies_from_file(INPUT_SQL_FILE)
    total_movies = len(movie_list)
    
    if total_movies == 0:
        print(f"âš ï¸ è­¦å‘Šï¼šåœ¨ {INPUT_SQL_FILE} ä¸­æœªæ‰¾åˆ°ä»»ä½• runtime=90 çš„ç”µå½±ã€‚")
        print("   å¯èƒ½åŸå› ï¼š")
        print("   1. æ–‡ä»¶åä¸å¯¹ã€‚")
        print("   2. æ–‡ä»¶é‡Œæ²¡æœ‰ INSERT INTO new_movies_staging è¯­å¥ã€‚")
        print("   3. ä¹‹å‰çš„çˆ¬è™«å·²ç»æŠ“å–äº†çœŸå®æ—¶é•¿(ä¸æ˜¯90)ã€‚")
        return

    print(f"âœ… è§£æå®Œæˆï¼å…±æ‰¾åˆ° {total_movies} éƒ¨å¾…ä¿®æ­£æ—¶é•¿çš„ç”µå½±ã€‚")
    print(f"ğŸš€ å¼€å§‹è”ç½‘æŸ¥è¯¢æ—¶é•¿ (è¾“å‡ºæ–‡ä»¶: {OUTPUT_SQL_FILE})...")

    # 2. å¼€å§‹æŸ¥è¯¢å¹¶å†™å…¥ç»“æœ
    with open(OUTPUT_SQL_FILE, "w", encoding="utf-8") as f:
        f.write(f"-- Runtime Fix Script for {INPUT_SQL_FILE}\n")
        f.write("-- Generated by fix_runtime_from_sql.py\n")
        f.write("BEGIN;\n\n")

        count = 0
        success_count = 0

        for m in movie_list:
            count += 1
            local_id = m['id']
            title = m['title']
            year = m['year']

            # æ‰“å°è¿›åº¦
            sys.stdout.write(f"\r[{count}/{total_movies}] æ­£åœ¨æŸ¥è¯¢: {title[:20]}... ({year})")
            sys.stdout.flush()

            try:
                # Step A: æœç´¢ç”µå½± (ä½¿ç”¨ params ä¼ å‚ï¼Œè‡ªåŠ¨å¤„ç†ç‰¹æ®Šç¬¦å·å¦‚ &)
                search_url = "https://api.themoviedb.org/3/search/movie"
                search_params = {
                    "api_key": API_KEY,
                    "query": title,
                    "year": year,
                    "page": 1
                }
                search_res = get_json(search_url, params=search_params)

                if search_res and search_res.get('results'):
                    # å–ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœ
                    tmdb_item = search_res['results'][0]
                    tmdb_id = tmdb_item['id']

                    # Step B: è·å–è¯¦æƒ…æ‹¿åˆ° Runtime
                    detail_url = f"https://api.themoviedb.org/3/movie/{tmdb_id}"
                    detail_params = {"api_key": API_KEY}
                    detail_res = get_json(detail_url, params=detail_params)

                    if detail_res:
                        runtime = detail_res.get('runtime', 0)
                        
                        # åªæœ‰æ—¶é•¿æœ‰æ•ˆä¸”ä¸ç­‰äº 90 æ—¶ï¼Œæ‰ç”Ÿæˆæ›´æ–°è¯­å¥
                        if runtime and runtime > 0 and runtime != 90:
                            # ğŸŸ¢ ç”Ÿæˆæé€Ÿ UPDATE è¯­å¥
                            sql = f"UPDATE new_movies_staging SET runtime = {runtime} WHERE movieid = {local_id};\n"
                            f.write(sql)
                            success_count += 1
            except Exception:
                # å¦‚æœæŸéƒ¨ç”µå½±æœä¸åˆ°æˆ–ç½‘ç»œé”™è¯¯ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸å½±å“æ•´ä½“
                continue
            
            # ç¨å¾®å¿«ä¸€ç‚¹ï¼Œå› ä¸ºæ˜¯ç²¾å‡†æœç´¢
            time.sleep(0.15)

        f.write("\nCOMMIT;\n")
        print(f"\n\nâœ… ä»»åŠ¡å¤§åŠŸå‘Šæˆï¼")
        print(f"ğŸ“Š æˆåŠŸç”Ÿæˆ: {success_count} æ¡æ›´æ–°è¯­å¥")
        print(f"ğŸ’¾ è¾“å‡ºæ–‡ä»¶: {OUTPUT_SQL_FILE}")
        print("ğŸ’¡ æ¥ä¸‹æ¥çš„æ­¥éª¤ï¼š")
        print("   1. ç¡®ä¿ä½ å·²ç»åœ¨ DataGrip é‡Œè¿è¡Œäº† filmdb_staging_update.sql (å»ºç«‹äº†ä¸´æ—¶è¡¨)ã€‚")
        print(f"   2. åœ¨ DataGrip é‡Œè¿è¡Œè¿™ä¸ª {OUTPUT_SQL_FILE}ã€‚")
        print("   3. æ‰§è¡Œæœ€åçš„åˆå¹¶è¯­å¥ (INSERT INTO movies SELECT...)ã€‚")

if __name__ == "__main__":
    main()